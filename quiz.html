<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuizMaster</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .quiz-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .quiz-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }
    
    .option-btn {
      transition: all 0.2s ease;
    }
    
    .option-btn:hover:not(.selected):not(.correct):not(.incorrect) {
      transform: scale(1.02);
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }
    
    .option-btn.selected {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }
    
    .option-btn.correct {
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.15);
    }
    
    .option-btn.incorrect {
      border-color: #ef4444;
      background: rgba(239, 68, 68, 0.15);
    }
    
    .fade-in {
      animation: fadeIn 0.4s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .pulse-dot {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
    }
    
    .progress-bar {
      transition: width 0.5s ease;
    }
    
    .score-circle {
      animation: scoreReveal 1s ease-out;
    }
    
    @keyframes scoreReveal {
      from { 
        stroke-dasharray: 0 283;
        opacity: 0;
      }
      to { 
        opacity: 1;
      }
    }

    .floating-shapes {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 0;
    }

    .shape {
      position: absolute;
      opacity: 0.1;
      animation: float 20s infinite ease-in-out;
    }

    .shape:nth-child(1) {
      top: 10%;
      left: 10%;
      animation-delay: 0s;
    }

    .shape:nth-child(2) {
      top: 60%;
      right: 10%;
      animation-delay: -5s;
    }

    .shape:nth-child(3) {
      bottom: 10%;
      left: 30%;
      animation-delay: -10s;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-30px) rotate(10deg); }
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(240, 147, 251, 0.4);
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }

    .toast {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full gradient-bg">
  <div id="app" class="h-full overflow-auto"><!-- Floating Shapes Background -->
   <div class="floating-shapes">
    <svg class="shape w-32 h-32" viewbox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="white" />
    </svg>
    <svg class="shape w-48 h-48" viewbox="0 0 100 100"><rect x="20" y="20" width="60" height="60" rx="10" fill="white" />
    </svg>
    <svg class="shape w-40 h-40" viewbox="0 0 100 100"><polygon points="50,10 90,90 10,90" fill="white" />
    </svg>
   </div><!-- Toast Container -->
   <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div><!-- Main Content -->
   <div id="main-content" class="relative z-10 min-h-full p-4 md:p-8"><!-- Home View -->
    <div id="home-view" class="max-w-6xl mx-auto fade-in">
     <!-- Role Switcher Button -->
     <div class="absolute top-8 right-8 flex gap-2">
      <button onclick="switchRole('teacher')" id="btn-teacher" class="px-4 py-2 rounded-lg border-2 border-white/30 text-white font-semibold hover:bg-white/20 transition">Guru</button>
      <button onclick="switchRole('student')" id="btn-student" class="px-4 py-2 rounded-lg border-2 border-white bg-white text-violet-600 font-semibold transition">Siswa</button>
     </div>

     <!-- Header -->
     <header class="text-center mb-12 pt-8">
      <div class="inline-flex items-center gap-3 mb-4">
       <div class="w-14 h-14 rounded-2xl bg-white/20 backdrop-blur flex items-center justify-center">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
        </svg>
       </div>
       <h1 id="app-title" class="text-4xl md:text-5xl font-extrabold text-white tracking-tight">QuizMaster</h1>
      </div>
      <p id="welcome-msg" class="text-white/80 text-lg md:text-xl max-w-2xl mx-auto">Selamat datang di platform kuis interaktif</p>
     </header><!-- Action Cards -->
     <div class="grid md:grid-cols-2 gap-6 mb-12"><!-- Create Quiz Card -->
      <div class="glass-card rounded-3xl p-8 quiz-card cursor-pointer" onclick="showView('create-quiz')">
       <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center mb-6">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
       </div>
       <h3 class="text-2xl font-bold text-gray-800 mb-3">Buat Kuis Baru</h3>
       <p class="text-gray-600">Buat kuis secara manual atau generate dari dokumen teks</p>
      </div><!-- Join Quiz Card -->
      <div class="glass-card rounded-3xl p-8 quiz-card cursor-pointer" onclick="showView('join-quiz')">
       <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center mb-6">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
        </svg>
       </div>
       <h3 class="text-2xl font-bold text-gray-800 mb-3">Ikuti Kuis</h3>
       <p class="text-gray-600">Masukkan kode kuis dan isi data Anda</p>
      </div>
     </div><!-- Available Quizzes -->
     <div class="glass-card rounded-3xl p-8">
      <div class="flex items-center justify-between mb-6">
       <h3 class="text-2xl font-bold text-gray-800">Kuis Tersedia</h3><span id="quiz-count" class="px-4 py-2 bg-violet-100 text-violet-700 rounded-full text-sm font-semibold">0 kuis</span>
      </div>
      <div id="quiz-list" class="grid gap-4">
       <div class="text-center py-12 text-gray-400">
        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
        </svg>
        <p>Belum ada kuis. Buat kuis pertama Anda!</p>
       </div>
      </div>
     </div>
    </div><!-- Create Quiz View -->
    <div id="create-quiz-view" class="max-w-4xl mx-auto fade-in hidden"><button onclick="showView('home')" class="flex items-center gap-2 text-white/80 hover:text-white mb-8 transition">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg> Kembali </button>
     <div class="glass-card rounded-3xl p-8">
      <h2 class="text-3xl font-bold text-gray-800 mb-8">Buat Kuis Baru</h2><!-- Tab Navigation -->
      <div class="flex gap-2 mb-8 bg-gray-100 p-1 rounded-xl"><button id="tab-manual" onclick="switchCreateTab('manual')" class="flex-1 py-3 px-6 rounded-lg font-semibold transition bg-white text-violet-700 shadow"> Manual </button> <button id="tab-document" onclick="switchCreateTab('document')" class="flex-1 py-3 px-6 rounded-lg font-semibold transition text-gray-600 hover:text-gray-800"> Dari Dokumen </button>
      </div><!-- Quiz Info -->
      <div class="space-y-4 mb-8">
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Judul Kuis</label> <input type="text" id="quiz-title" placeholder="Contoh: Kuis Matematika Bab 1" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-violet-500 transition">
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Deskripsi (opsional)</label> <textarea id="quiz-description" rows="2" placeholder="Deskripsi singkat tentang kuis ini" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-violet-500 transition resize-none"></textarea>
       </div>
       <div><label class="flex items-center gap-3 cursor-pointer">
         <input type="checkbox" id="quiz-shuffle" class="w-5 h-5 text-violet-600 rounded cursor-pointer">
         <span class="text-sm font-semibold text-gray-700">Acak urutan soal</span>
        </label>
       </div>
      </div><!-- Manual Tab Content -->
      <div id="manual-content">
       <div id="questions-container" class="space-y-6 mb-6"><!-- Questions will be added here -->
       </div><button onclick="addQuestion()" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-violet-500 hover:text-violet-600 transition flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg> Tambah Pertanyaan </button>
      </div><!-- Document Tab Content -->
      <div id="document-content" class="hidden">
       <div class="mb-6"><label class="block text-sm font-semibold text-gray-700 mb-2">Paste Teks Dokumen</label> <textarea id="document-text" rows="8" placeholder="Paste konten dokumen di sini. Format yang didukung:

1. Apa ibu kota Indonesia?
a. Jakarta
b. Surabaya
c. Bandung
d. Medan
Jawaban: a

2. Siapa presiden pertama RI?
..." class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-violet-500 transition resize-none font-mono text-sm"></textarea>
       </div><button onclick="parseDocument()" class="btn-secondary text-white px-6 py-3 rounded-xl font-semibold"> Generate Pertanyaan </button>
      </div><!-- Save Button -->
      <div class="mt-8 pt-6 border-t border-gray-200"><button onclick="saveQuiz()" id="save-quiz-btn" class="btn-primary text-white px-8 py-4 rounded-xl font-bold text-lg w-full"> Simpan Kuis </button>
      </div>
     </div>
    </div><!-- Join Quiz View -->
    <div id="join-quiz-view" class="max-w-md mx-auto fade-in hidden"><button onclick="showView('home')" class="flex items-center gap-2 text-white/80 hover:text-white mb-8 transition">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg> Kembali </button>
     <div class="glass-card rounded-3xl p-8 text-center">
      <div class="w-20 h-20 rounded-full bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center mx-auto mb-6">
       <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
       </svg>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Masuk untuk Mengerjakan Kuis</h2>
      <div id="quiz-code-step" class="space-y-4 text-left">
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Kode Kuis</label> <input type="text" id="quiz-code" placeholder="Masukkan kode kuis" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-pink-500 transition uppercase">
       </div>
      </div><button onclick="verifyQuizCode()" class="btn-secondary text-white px-8 py-4 rounded-xl font-bold text-lg w-full mt-8"> Lanjut </button>
      <div id="participant-info-step" class="hidden">
       <div class="space-y-4 text-left mt-6">
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Nama Lengkap</label> <input type="text" id="participant-name" placeholder="Masukkan nama lengkap" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-pink-500 transition">
        </div>
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Nomor Absen</label> <input type="text" id="participant-number" placeholder="Contoh: 15" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-pink-500 transition">
        </div>
       </div><button onclick="joinQuiz()" class="btn-secondary text-white px-8 py-4 rounded-xl font-bold text-lg w-full mt-8"> Mulai Kuis </button>
      </div>
     </div>
    </div><!-- Take Quiz View -->
    <div id="take-quiz-view" class="max-w-3xl mx-auto fade-in hidden">
     <div class="glass-card rounded-3xl p-8"><!-- Quiz Header -->
      <div class="flex items-center justify-between mb-6">
       <div>
        <h2 id="taking-quiz-title" class="text-2xl font-bold text-gray-800">Judul Kuis</h2>
        <p id="taking-participant-info" class="text-gray-500">Peserta</p>
       </div>
       <div class="text-right">
        <p class="text-sm text-gray-500">Pertanyaan</p>
        <p id="question-counter" class="text-2xl font-bold text-violet-600">1/10</p>
       </div>
      </div><!-- Progress Bar -->
      <div class="h-2 bg-gray-200 rounded-full mb-8 overflow-hidden">
       <div id="quiz-progress" class="progress-bar h-full bg-gradient-to-r from-violet-500 to-purple-600 rounded-full" style="width: 0%"></div>
      </div><!-- Question -->
      <div id="question-container" class="mb-8">
       <p id="current-question" class="text-xl font-semibold text-gray-800 mb-6">Pertanyaan akan muncul di sini</p>
       <div id="options-container" class="space-y-3"><!-- Options will be rendered here -->
       </div>
      </div><!-- Navigation -->
      <div class="flex gap-4"><button onclick="prevQuestion()" id="prev-btn" class="flex-1 py-4 rounded-xl border-2 border-gray-200 text-gray-600 font-semibold hover:border-gray-300 transition disabled:opacity-50" disabled> Sebelumnya </button> <button onclick="nextQuestion()" id="next-btn" class="flex-1 btn-primary text-white py-4 rounded-xl font-semibold"> Selanjutnya </button>
      </div>
     </div>
    </div><!-- Result View -->
    <div id="result-view" class="max-w-2xl mx-auto fade-in hidden">
     <div class="glass-card rounded-3xl p-8 text-center">
      <div class="mb-8">
       <div class="relative w-48 h-48 mx-auto mb-6">
        <svg class="w-full h-full transform -rotate-90"><circle cx="96" cy="96" r="88" fill="none" stroke="#e5e7eb" stroke-width="12" /> <circle id="score-circle" cx="96" cy="96" r="88" fill="none" stroke="url(#gradient)" stroke-width="12" stroke-linecap="round" stroke-dasharray="0 553" class="score-circle" /> <defs>
          <lineargradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
           <stop offset="0%" stop-color="#667eea" />
           <stop offset="100%" stop-color="#f093fb" />
          </lineargradient>
         </defs>
        </svg>
        <div class="absolute inset-0 flex flex-col items-center justify-center"><span id="score-percent" class="text-5xl font-extrabold text-gray-800">0%</span> <span class="text-gray-500">Skor</span>
        </div>
       </div>
       <h2 id="result-title" class="text-3xl font-bold text-gray-800 mb-2">Selesai!</h2>
       <p id="result-message" class="text-gray-600 text-lg">Anda berhasil menyelesaikan kuis</p>
      </div>
      <div class="grid grid-cols-2 gap-4 mb-8">
       <div class="bg-green-50 rounded-2xl p-4">
        <p class="text-3xl font-bold text-green-600" id="correct-count">0</p>
        <p class="text-green-600">Benar</p>
       </div>
       <div class="bg-red-50 rounded-2xl p-4">
        <p class="text-3xl font-bold text-red-500" id="incorrect-count">0</p>
        <p class="text-red-500">Salah</p>
       </div>
      </div><!-- Review Answers -->
      <div class="text-left mb-8">
       <h3 class="font-bold text-gray-800 mb-4">Review Jawaban</h3>
       <div id="review-container" class="space-y-4 max-h-96 overflow-y-auto"><!-- Reviews will be rendered here -->
       </div>
      </div><button onclick="showView('home')" class="btn-primary text-white px-8 py-4 rounded-xl font-bold text-lg w-full"> Kembali ke Beranda </button>
     </div>
    </div><!-- Quiz Detail View (for creators) -->
    <div id="quiz-detail-view" class="max-w-4xl mx-auto fade-in hidden"><button onclick="showView('home')" class="flex items-center gap-2 text-white/80 hover:text-white mb-8 transition">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg> Kembali </button>
     <div class="glass-card rounded-3xl p-8 mb-6">
      <div class="flex items-start justify-between mb-6">
       <div>
        <h2 id="detail-quiz-title" class="text-3xl font-bold text-gray-800 mb-2">Judul Kuis</h2>
        <p id="detail-quiz-desc" class="text-gray-600">Deskripsi kuis</p>
       </div>
       <div class="text-right">
        <p class="text-sm text-gray-500 mb-1">Kode Kuis</p>
        <p id="detail-quiz-code" class="text-2xl font-mono font-bold text-violet-600 bg-violet-50 px-4 py-2 rounded-xl">XXXX</p>
       </div>
      </div>
      <div class="flex gap-4 mb-6">
       <div class="flex-1 bg-violet-50 rounded-xl p-4 text-center">
        <p id="detail-question-count" class="text-3xl font-bold text-violet-600">0</p>
        <p class="text-violet-600 text-sm">Pertanyaan</p>
       </div>
       <div class="flex-1 bg-pink-50 rounded-xl p-4 text-center">
        <p id="detail-participant-count" class="text-3xl font-bold text-pink-600">0</p>
        <p class="text-pink-600 text-sm">Peserta</p>
       </div>
       <div class="flex-1 bg-green-50 rounded-xl p-4 text-center">
        <p id="detail-avg-score" class="text-3xl font-bold text-green-600">-</p>
        <p class="text-green-600 text-sm">Rata-rata</p>
       </div>
      </div>
      <div class="flex gap-3"><button onclick="confirmDeleteQuiz()" id="delete-quiz-btn" class="px-6 py-3 rounded-xl border-2 border-red-200 text-red-600 font-semibold hover:bg-red-50 transition"> Hapus Kuis </button>
      </div>
     </div><!-- Participants Results -->
     <div class="glass-card rounded-3xl p-8">
      <h3 class="text-xl font-bold text-gray-800 mb-6">Hasil Peserta</h3>
      <div id="participants-results" class="space-y-3">
       <p class="text-gray-400 text-center py-8">Belum ada peserta yang mengerjakan kuis ini</p>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Default configuration
    const defaultConfig = {
      app_title: 'QuizMaster',
      welcome_message: 'Selamat datang di platform kuis interaktif',
      background_color: '#667eea',
      surface_color: '#ffffff',
      text_color: '#1f2937',
      primary_action_color: '#667eea',
      secondary_action_color: '#f093fb'
    };

    // App State
    let allData = [];
    let currentQuizId = null;
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let currentParticipant = { name: '', number: '' };
    let tempQuestions = [];
    let questionCounter = 0;
    let deleteConfirmTarget = null;

    // Simple Data SDK Fallback using localStorage
    if (!window.dataSdk) {
      window.dataSdk = {
        async init(options) {
          try {
            // Load data from localStorage
            const stored = localStorage.getItem('quiz_data');
            allData = stored ? JSON.parse(stored) : [];
            
            if (options.onDataChanged) {
              options.onDataChanged(allData);
            }
            
            return { isOk: true };
          } catch (error) {
            console.error('Error initializing dataSdk:', error);
            return { isOk: false, message: error.message };
          }
        },
        
        async create(data) {
          try {
            // Generate a backend ID
            const backendId = 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const newData = {
              ...data,
              __backendId: backendId,
              created_at: new Date().toISOString()
            };
            
            allData.push(newData);
            localStorage.setItem('quiz_data', JSON.stringify(allData));
            
            console.log('Data saved to localStorage:', newData);
            
            return { 
              isOk: true, 
              backendId: backendId,
              data: newData
            };
          } catch (error) {
            console.error('Error creating data:', error);
            return { isOk: false, message: error.message };
          }
        },
        
        async update(id, data) {
          try {
            const index = allData.findIndex(d => d.__backendId === id);
            if (index !== -1) {
              allData[index] = { ...allData[index], ...data, updated_at: new Date().toISOString() };
              localStorage.setItem('quiz_data', JSON.stringify(allData));
              return { isOk: true };
            }
            return { isOk: false, message: 'Data not found' };
          } catch (error) {
            console.error('Error updating data:', error);
            return { isOk: false, message: error.message };
          }
        },
        
        async delete(id) {
          try {
            const index = allData.findIndex(d => d.__backendId === id);
            if (index !== -1) {
              allData.splice(index, 1);
              localStorage.setItem('quiz_data', JSON.stringify(allData));
              return { isOk: true };
            }
            return { isOk: false, message: 'Data not found' };
          } catch (error) {
            console.error('Error deleting data:', error);
            return { isOk: false, message: error.message };
          }
        }
      };
    }

    // Initialize SDKs
    async function initApp() {
      // Initialize Element SDK
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            const titleEl = document.getElementById('app-title');
            const welcomeEl = document.getElementById('welcome-msg');
            
            if (titleEl) titleEl.textContent = config.app_title || defaultConfig.app_title;
            if (welcomeEl) welcomeEl.textContent = config.welcome_message || defaultConfig.welcome_message;
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (v) => window.elementSdk.setConfig({ background_color: v })
              },
              {
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (v) => window.elementSdk.setConfig({ surface_color: v })
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (v) => window.elementSdk.setConfig({ text_color: v })
              },
              {
                get: () => config.primary_action_color || defaultConfig.primary_action_color,
                set: (v) => window.elementSdk.setConfig({ primary_action_color: v })
              },
              {
                get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                set: (v) => window.elementSdk.setConfig({ secondary_action_color: v })
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['app_title', config.app_title || defaultConfig.app_title],
            ['welcome_message', config.welcome_message || defaultConfig.welcome_message]
          ])
        });
      }

      // Initialize Data SDK
      if (window.dataSdk) {
        try {
          const result = await window.dataSdk.init({
            onDataChanged: (data) => {
              allData = data;
              renderQuizList();
            }
          });
          
          if (!result.isOk) {
            console.error('Gagal memuat data:', result.message);
            showToast('Gagal memuat data', 'error');
          }
        } catch (error) {
          console.error('Error initializing dataSdk:', error);
          showToast('Error: ' + error.message, 'error');
        }
      } else {
        console.warn('dataSdk tidak tersedia');
      }

      // Initialize with one question
      addQuestion();

      // Update button states based on current role
      const userRole = localStorage.getItem('userRole') || 'teacher';
      const btnTeacher = document.getElementById('btn-teacher');
      const btnStudent = document.getElementById('btn-student');
      
      if (userRole === 'teacher') {
        btnTeacher.className = 'px-4 py-2 rounded-lg border-2 border-white bg-white text-violet-600 font-semibold transition';
        btnStudent.className = 'px-4 py-2 rounded-lg border-2 border-white/30 text-white font-semibold hover:bg-white/20 transition';
      } else {
        btnStudent.className = 'px-4 py-2 rounded-lg border-2 border-white bg-white text-violet-600 font-semibold transition';
        btnTeacher.className = 'px-4 py-2 rounded-lg border-2 border-white/30 text-white font-semibold hover:bg-white/20 transition';
      }
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-violet-500';
      
      toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-xl shadow-lg font-medium`;
      toast.textContent = message;
      container.appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }

    // View Management
    function showView(viewName) {
      const views = ['home-view', 'create-quiz-view', 'join-quiz-view', 'take-quiz-view', 'result-view', 'quiz-detail-view'];
      views.forEach(v => {
        const el = document.getElementById(v);
        if (el) el.classList.add('hidden');
      });
      
      const targetView = document.getElementById(`${viewName}-view`);
      if (targetView) {
        targetView.classList.remove('hidden');
        targetView.classList.add('fade-in');
      }

      // Reset state when going home
      if (viewName === 'home') {
        currentQuizId = null;
        currentQuestionIndex = 0;
        userAnswers = [];
        deleteConfirmTarget = null;
      }

      // Reset join quiz form when going back
      if (viewName === 'join-quiz') {
        document.getElementById('quiz-code').value = '';
        document.getElementById('participant-name').value = '';
        document.getElementById('participant-number').value = '';
        document.getElementById('quiz-code-step').classList.remove('hidden');
        document.getElementById('participant-info-step').classList.add('hidden');
      }
    }

    // Switch user role (teacher/student)
    function switchRole(role) {
      localStorage.setItem('userRole', role);
      
      // Update button states
      const btnTeacher = document.getElementById('btn-teacher');
      const btnStudent = document.getElementById('btn-student');
      
      if (role === 'teacher') {
        btnTeacher.className = 'px-4 py-2 rounded-lg border-2 border-white bg-white text-violet-600 font-semibold transition';
        btnStudent.className = 'px-4 py-2 rounded-lg border-2 border-white/30 text-white font-semibold hover:bg-white/20 transition';
        showView('home');
      } else {
        btnStudent.className = 'px-4 py-2 rounded-lg border-2 border-white bg-white text-violet-600 font-semibold transition';
        btnTeacher.className = 'px-4 py-2 rounded-lg border-2 border-white/30 text-white font-semibold hover:bg-white/20 transition';
        showView('join-quiz');
      }
    }

    // Tab switching for create quiz
    function switchCreateTab(tab) {
      const manualTab = document.getElementById('tab-manual');
      const documentTab = document.getElementById('tab-document');
      const manualContent = document.getElementById('manual-content');
      const documentContent = document.getElementById('document-content');

      if (tab === 'manual') {
        manualTab.className = 'flex-1 py-3 px-6 rounded-lg font-semibold transition bg-white text-violet-700 shadow';
        documentTab.className = 'flex-1 py-3 px-6 rounded-lg font-semibold transition text-gray-600 hover:text-gray-800';
        manualContent.classList.remove('hidden');
        documentContent.classList.add('hidden');
      } else {
        documentTab.className = 'flex-1 py-3 px-6 rounded-lg font-semibold transition bg-white text-violet-700 shadow';
        manualTab.className = 'flex-1 py-3 px-6 rounded-lg font-semibold transition text-gray-600 hover:text-gray-800';
        documentContent.classList.remove('hidden');
        manualContent.classList.add('hidden');
      }
    }

    // Add question to manual form
    function addQuestion() {
      questionCounter++;
      const container = document.getElementById('questions-container');
      const questionDiv = document.createElement('div');
      questionDiv.className = 'bg-gray-50 rounded-2xl p-6 relative fade-in';
      questionDiv.id = `question-${questionCounter}`;
      
      questionDiv.innerHTML = `
        <button onclick="removeQuestion(${questionCounter})" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-red-100 text-red-500 hover:bg-red-200 transition flex items-center justify-center">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Pertanyaan ${questionCounter}</label>
        <div class="mb-4">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Tipe Pertanyaan</label>
          <select class="question-type w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-violet-500 transition" onchange="toggleQuestionType(this, ${questionCounter})">
            <option value="multiple">Pilihan Ganda</option>
            <option value="essay">Essay</option>
          </select>
        </div>
        <input type="text" class="question-text w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-violet-500 transition mb-4" placeholder="Tulis pertanyaan di sini">
        <div class="multiple-choice-section-${questionCounter}">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="flex items-center gap-2 text-sm text-gray-600 mb-1">
                <input type="radio" name="correct-${questionCounter}" value="a" class="text-violet-600">
                <span>Opsi A (Benar)</span>
              </label>
              <input type="text" class="option-a w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-violet-500 transition text-sm" placeholder="Opsi A">
            </div>
            <div>
              <label class="flex items-center gap-2 text-sm text-gray-600 mb-1">
                <input type="radio" name="correct-${questionCounter}" value="b" class="text-violet-600">
                <span>Opsi B</span>
              </label>
              <input type="text" class="option-b w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-violet-500 transition text-sm" placeholder="Opsi B">
            </div>
            <div>
              <label class="flex items-center gap-2 text-sm text-gray-600 mb-1">
                <input type="radio" name="correct-${questionCounter}" value="c" class="text-violet-600">
                <span>Opsi C</span>
              </label>
              <input type="text" class="option-c w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-violet-500 transition text-sm" placeholder="Opsi C">
            </div>
            <div>
              <label class="flex items-center gap-2 text-sm text-gray-600 mb-1">
                <input type="radio" name="correct-${questionCounter}" value="d" class="text-violet-600">
                <span>Opsi D</span>
              </label>
              <input type="text" class="option-d w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-violet-500 transition text-sm" placeholder="Opsi D">
            </div>
          </div>
        </div>
      `;
      
      container.appendChild(questionDiv);
    }

    function toggleQuestionType(selectElement, questionCounter) {
      const type = selectElement.value;
      const multipleChoiceSection = document.querySelector(`.multiple-choice-section-${questionCounter}`);
      
      if (type === 'essay') {
        multipleChoiceSection.classList.add('hidden');
      } else {
        multipleChoiceSection.classList.remove('hidden');
      }
    }

    function removeQuestion(id) {
      const questionDiv = document.getElementById(`question-${id}`);
      if (questionDiv) {
        questionDiv.remove();
      }
    }

    // Parse document to questions
    function parseDocument() {
      const text = document.getElementById('document-text').value;
      if (!text.trim()) {
        showToast('Silakan paste teks dokumen terlebih dahulu', 'error');
        return;
      }

      // Clear existing questions
      document.getElementById('questions-container').innerHTML = '';
      questionCounter = 0;

      // Simple parser for question format
      const lines = text.split('\n').filter(l => l.trim());
      let currentQuestion = null;
      let questions = [];

      for (let line of lines) {
        line = line.trim();
        
        // Check for question number pattern
        const questionMatch = line.match(/^(\d+)[.)]\s*(.+)/);
        if (questionMatch) {
          if (currentQuestion && currentQuestion.text) {
            questions.push(currentQuestion);
          }
          currentQuestion = {
            text: questionMatch[2],
            options: { a: '', b: '', c: '', d: '' },
            correct: 'a'
          };
          continue;
        }

        // Check for options
        const optionMatch = line.match(/^([a-d])[.)]\s*(.+)/i);
        if (optionMatch && currentQuestion) {
          currentQuestion.options[optionMatch[1].toLowerCase()] = optionMatch[2];
          continue;
        }

        // Check for answer
        const answerMatch = line.match(/^(?:jawaban|answer|kunci)[:\s]*([a-d])/i);
        if (answerMatch && currentQuestion) {
          currentQuestion.correct = answerMatch[1].toLowerCase();
          continue;
        }
      }

      // Add last question
      if (currentQuestion && currentQuestion.text) {
        questions.push(currentQuestion);
      }

      if (questions.length === 0) {
        showToast('Tidak dapat menemukan pertanyaan. Periksa format dokumen.', 'error');
        return;
      }

      // Add questions to form
      questions.forEach(q => {
        questionCounter++;
        const container = document.getElementById('questions-container');
        const questionDiv = document.createElement('div');
        questionDiv.className = 'bg-gray-50 rounded-2xl p-6 relative fade-in';
        questionDiv.id = `question-${questionCounter}`;
        
        const multipleChoiceHTML = `
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="flex items-center gap-2 text-sm text-gray-600 mb-1">
                <input type="radio" name="correct-${questionCounter}" value="a" class="text-violet-600" ${q.correct === 'a' ? 'checked' : ''}>
                <span>Opsi A ${q.correct === 'a' ? '(Benar)' : ''}</span>
              </label>
              <input type="text" class="option-a w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-violet-500 transition text-sm" placeholder="Opsi A" value="${escapeHtml(q.options?.a || '')}">
            </div>
            <div>
              <label class="flex items-center gap-2 text-sm text-gray-600 mb-1">
                <input type="radio" name="correct-${questionCounter}" value="b" class="text-violet-600" ${q.correct === 'b' ? 'checked' : ''}>
                <span>Opsi B ${q.correct === 'b' ? '(Benar)' : ''}</span>
              </label>
              <input type="text" class="option-b w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-violet-500 transition text-sm" placeholder="Opsi B" value="${escapeHtml(q.options?.b || '')}">
            </div>
            <div>
              <label class="flex items-center gap-2 text-sm text-gray-600 mb-1">
                <input type="radio" name="correct-${questionCounter}" value="c" class="text-violet-600" ${q.correct === 'c' ? 'checked' : ''}>
                <span>Opsi C ${q.correct === 'c' ? '(Benar)' : ''}</span>
              </label>
              <input type="text" class="option-c w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-violet-500 transition text-sm" placeholder="Opsi C" value="${escapeHtml(q.options?.c || '')}">
            </div>
            <div>
              <label class="flex items-center gap-2 text-sm text-gray-600 mb-1">
                <input type="radio" name="correct-${questionCounter}" value="d" class="text-violet-600" ${q.correct === 'd' ? 'checked' : ''}>
                <span>Opsi D ${q.correct === 'd' ? '(Benar)' : ''}</span>
              </label>
              <input type="text" class="option-d w-full px-3 py-2 rounded-lg border border-gray-200 focus:border-violet-500 transition text-sm" placeholder="Opsi D" value="${escapeHtml(q.options?.d || '')}">
            </div>
          </div>
        `;

        const questionType = q.type || 'multiple';
        
        questionDiv.innerHTML = `
          <button onclick="removeQuestion(${questionCounter})" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-red-100 text-red-500 hover:bg-red-200 transition flex items-center justify-center">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Pertanyaan ${questionCounter}</label>
          <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Tipe Pertanyaan</label>
            <select class="question-type w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-violet-500 transition" onchange="toggleQuestionType(this, ${questionCounter})" value="${questionType}">
              <option value="multiple">Pilihan Ganda</option>
              <option value="essay">Essay</option>
            </select>
          </div>
          <input type="text" class="question-text w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-violet-500 transition mb-4" placeholder="Tulis pertanyaan di sini" value="${escapeHtml(q.text)}">
          <div class="multiple-choice-section-${questionCounter}" ${questionType === 'essay' ? 'style="display:none"' : ''}>
            ${multipleChoiceHTML}
          </div>
        `;
        
        container.appendChild(questionDiv);
      });

      // Switch to manual tab to show parsed questions
      switchCreateTab('manual');
      showToast(`${questions.length} pertanyaan berhasil di-generate!`, 'success');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Generate quiz code
    function generateCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = '';
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Shuffle array using Fisher-Yates algorithm
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // Save Quiz
    async function saveQuiz() {
      const title = document.getElementById('quiz-title').value.trim();
      const description = document.getElementById('quiz-description').value.trim();

      if (!title) {
        showToast('Silakan isi judul kuis', 'error');
        return;
      }

      // Collect questions from form
      const questionDivs = document.querySelectorAll('#questions-container > div');
      const questions = [];

      for (const div of questionDivs) {
        const text = div.querySelector('.question-text').value.trim();
        const type = div.querySelector('.question-type').value;

        if (!text) continue;

        if (type === 'essay') {
          questions.push({
            text,
            type: 'essay'
          });
        } else {
          const optionA = div.querySelector('.option-a').value.trim();
          const optionB = div.querySelector('.option-b').value.trim();
          const optionC = div.querySelector('.option-c').value.trim();
          const optionD = div.querySelector('.option-d').value.trim();
          const correctRadio = div.querySelector('input[type="radio"]:checked');
          const correct = correctRadio ? correctRadio.value : 'a';

          if (optionA) {
            questions.push({
              text,
              type: 'multiple',
              options: { a: optionA, b: optionB, c: optionC, d: optionD },
              correct
            });
          }
        }
      }

      if (questions.length === 0) {
        showToast('Tambahkan minimal 1 pertanyaan', 'error');
        return;
      }

      // Check data limit
      if (allData.length >= 999) {
        showToast('Batas penyimpanan tercapai. Hapus beberapa kuis terlebih dahulu.', 'error');
        return;
      }

      const saveBtn = document.getElementById('save-quiz-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Menyimpan...';

      const quiz = {
        type: 'quiz',
        quiz_id: 'quiz_' + Date.now(),
        quiz_title: title,
        quiz_description: description,
        quiz_questions: JSON.stringify(questions),
        quiz_shuffle: document.getElementById('quiz-shuffle').checked,
        quiz_created_at: new Date().toISOString()
      };

      // Check if dataSdk is available
      if (!window.dataSdk) {
        showToast('SDK data tidak tersedia. Silakan refresh halaman', 'error');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Simpan Kuis';
        return;
      }

      try {
        const result = await window.dataSdk.create(quiz);
        
        saveBtn.disabled = false;
        saveBtn.textContent = 'Simpan Kuis';

        if (result && result.isOk) {
          // Tambahkan quiz ke allData untuk ditampilkan langsung
          allData.push({
            ...quiz,
            __backendId: result.backendId || quiz.quiz_id
          });
          
          showToast('Kuis berhasil disimpan!', 'success');
          // Reset form
          document.getElementById('quiz-title').value = '';
          document.getElementById('quiz-description').value = '';
          document.getElementById('questions-container').innerHTML = '';
          questionCounter = 0;
          addQuestion();
          
          // Render ulang daftar kuis
          renderQuizList();
          
          showView('home');
        } else {
          showToast('Gagal menyimpan kuis: ' + (result?.message || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('Error saving quiz:', error);
        showToast('Error: ' + error.message, 'error');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Simpan Kuis';
      }
    }

    // Render quiz list
    function renderQuizList() {
      const quizzes = allData.filter(d => d.type === 'quiz');
      const container = document.getElementById('quiz-list');
      const countEl = document.getElementById('quiz-count');
      
      countEl.textContent = `${quizzes.length} kuis`;

      if (quizzes.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12 text-gray-400">
            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
            <p>Belum ada kuis. Buat kuis pertama Anda!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = quizzes.map(quiz => {
        const questions = JSON.parse(quiz.quiz_questions || '[]');
        const results = allData.filter(d => d.type === 'result' && d.result_quiz_id === quiz.quiz_id);
        const code = quiz.quiz_id.replace('quiz_', '').slice(-6).toUpperCase();
        
        return `
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition cursor-pointer" onclick="viewQuizDetail('${quiz.__backendId}')">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
              </div>
              <div>
                <h4 class="font-semibold text-gray-800">${escapeHtml(quiz.quiz_title)}</h4>
                <p class="text-sm text-gray-500">${questions.length} pertanyaan â€¢ ${results.length} peserta</p>
              </div>
            </div>
            <div class="text-right">
              <p class="font-mono font-bold text-violet-600 bg-violet-50 px-3 py-1 rounded-lg">${code}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    // View quiz detail
    function viewQuizDetail(backendId) {
      const quiz = allData.find(d => d.__backendId === backendId);
      if (!quiz) return;

      currentQuizId = backendId;
      const questions = JSON.parse(quiz.quiz_questions || '[]');
      const results = allData.filter(d => d.type === 'result' && d.result_quiz_id === quiz.quiz_id);
      const code = quiz.quiz_id.replace('quiz_', '').slice(-6).toUpperCase();

      document.getElementById('detail-quiz-title').textContent = quiz.quiz_title;
      document.getElementById('detail-quiz-desc').textContent = quiz.quiz_description || 'Tidak ada deskripsi';
      document.getElementById('detail-quiz-code').textContent = code;
      document.getElementById('detail-question-count').textContent = questions.length;
      document.getElementById('detail-participant-count').textContent = results.length;

      // Calculate average
      if (results.length > 0) {
        const avg = results.reduce((sum, r) => sum + (r.result_score / r.result_total * 100), 0) / results.length;
        document.getElementById('detail-avg-score').textContent = Math.round(avg) + '%';
      } else {
        document.getElementById('detail-avg-score').textContent = '-';
      }

      // Render participants
      const participantsContainer = document.getElementById('participants-results');
      if (results.length === 0) {
        participantsContainer.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada peserta yang mengerjakan kuis ini</p>';
      } else {
        const sortedResults = [...results].sort((a, b) => b.result_score - a.result_score);
        participantsContainer.innerHTML = sortedResults.map((r, idx) => {
          const percent = Math.round(r.result_score / r.result_total * 100);
          const medal = idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : idx === 2 ? 'ðŸ¥‰' : '';
          return `
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
              <div class="flex items-center gap-3">
                <span class="text-xl">${medal || (idx + 1)}</span>
                <div>
                  <p class="font-semibold text-gray-800">${escapeHtml(r.result_participant_name)}</p>
                  <p class="text-sm text-gray-500">Absen: ${r.result_participant_number}</p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-2xl font-bold ${percent >= 70 ? 'text-green-600' : percent >= 50 ? 'text-yellow-600' : 'text-red-500'}">${percent}%</p>
                <p class="text-sm text-gray-500">${r.result_score}/${r.result_total} benar</p>
              </div>
            </div>
          `;
        }).join('');
      }

      // Reset delete confirm state
      deleteConfirmTarget = null;
      document.getElementById('delete-quiz-btn').textContent = 'Hapus Kuis';
      document.getElementById('delete-quiz-btn').classList.remove('bg-red-500', 'text-white');

      showView('quiz-detail');
    }

    // Confirm delete quiz
    function confirmDeleteQuiz() {
      const deleteBtn = document.getElementById('delete-quiz-btn');
      
      if (deleteConfirmTarget === currentQuizId) {
        // Second click - actually delete
        deleteQuiz();
      } else {
        // First click - show confirmation
        deleteConfirmTarget = currentQuizId;
        deleteBtn.textContent = 'Klik lagi untuk konfirmasi';
        deleteBtn.classList.add('bg-red-500', 'text-white');
        
        // Reset after 3 seconds
        setTimeout(() => {
          if (deleteConfirmTarget === currentQuizId) {
            deleteConfirmTarget = null;
            deleteBtn.textContent = 'Hapus Kuis';
            deleteBtn.classList.remove('bg-red-500', 'text-white');
          }
        }, 3000);
      }
    }

    // Delete quiz
    async function deleteQuiz() {
      const quiz = allData.find(d => d.__backendId === currentQuizId);
      if (!quiz) {
        showToast('Kuis tidak ditemukan', 'error');
        return;
      }

      const deleteBtn = document.getElementById('delete-quiz-btn');
      deleteBtn.disabled = true;
      deleteBtn.textContent = 'Menghapus...';

      try {
        // Delete quiz by __backendId
        const result = await window.dataSdk.delete(quiz.__backendId);
        
        if (result.isOk) {
          // Delete related results
          const relatedResults = allData.filter(d => d.type === 'result' && d.result_quiz_id === quiz.quiz_id);
          for (const r of relatedResults) {
            await window.dataSdk.delete(r.__backendId);
          }
          showToast('Kuis berhasil dihapus', 'success');
          showView('home');
        } else {
          showToast('Gagal menghapus kuis: ' + (result.message || 'Unknown error'), 'error');
          deleteBtn.disabled = false;
          deleteBtn.textContent = 'Hapus Kuis';
        }
      } catch (error) {
        console.error('Error deleting quiz:', error);
        showToast('Error: ' + error.message, 'error');
        deleteBtn.disabled = false;
        deleteBtn.textContent = 'Hapus Kuis';
      }
    }

    // Join quiz
    function verifyQuizCode() {
      const code = document.getElementById('quiz-code').value.trim().toUpperCase();

      if (!code) {
        showToast('Masukkan kode kuis terlebih dahulu', 'error');
        return;
      }

      // Find quiz by code
      const quiz = allData.find(d => {
        if (d.type !== 'quiz') return false;
        const quizCode = d.quiz_id.replace('quiz_', '').slice(-6).toUpperCase();
        return quizCode === code;
      });

      if (!quiz) {
        showToast('Kode kuis tidak ditemukan', 'error');
        return;
      }

      // Show participant info step
      document.getElementById('quiz-code-step').classList.add('hidden');
      document.getElementById('participant-info-step').classList.remove('hidden');
      showToast('Kode kuis valid. Silakan isi data Anda', 'success');
    }

    function joinQuiz() {
      const name = document.getElementById('participant-name').value.trim();
      const number = document.getElementById('participant-number').value.trim();
      const code = document.getElementById('quiz-code').value.trim().toUpperCase();

      if (!name || !number || !code) {
        showToast('Lengkapi semua data untuk melanjutkan', 'error');
        return;
      }

      // Find quiz by code
      const quiz = allData.find(d => {
        if (d.type !== 'quiz') return false;
        const quizCode = d.quiz_id.replace('quiz_', '').slice(-6).toUpperCase();
        return quizCode === code;
      });

      if (!quiz) {
        showToast('Kode kuis tidak ditemukan', 'error');
        return;
      }

      currentParticipant = { name, number };
      currentQuizId = quiz.__backendId;
      currentQuestionIndex = 0;
      userAnswers = [];

      startQuiz(quiz);
    }

    // Start quiz
    function startQuiz(quiz) {
      const questions = JSON.parse(quiz.quiz_questions || '[]');
      
      // Shuffle questions if enabled
      if (quiz.quiz_shuffle) {
        tempQuestions = shuffleArray([...questions]);
      } else {
        tempQuestions = questions;
      }
      
      userAnswers = new Array(tempQuestions.length).fill(null);

      document.getElementById('taking-quiz-title').textContent = quiz.quiz_title;
      document.getElementById('taking-participant-info').textContent = `${currentParticipant.name} â€¢ Absen ${currentParticipant.number}`;

      renderQuestion();
      showView('take-quiz');
    }

    // Render current question
    function renderQuestion() {
      const question = tempQuestions[currentQuestionIndex];
      const total = tempQuestions.length;

      document.getElementById('question-counter').textContent = `${currentQuestionIndex + 1}/${total}`;
      document.getElementById('quiz-progress').style.width = `${((currentQuestionIndex + 1) / total) * 100}%`;
      document.getElementById('current-question').textContent = question.text;

      const optionsContainer = document.getElementById('options-container');

      if (question.type === 'essay') {
        const essayAnswer = userAnswers[currentQuestionIndex] || '';
        optionsContainer.innerHTML = `
          <textarea id="essay-answer" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-violet-500 transition" rows="6" placeholder="Tulis jawaban Anda di sini..." onchange="selectEssayAnswer(this.value)">${escapeHtml(essayAnswer)}</textarea>
        `;
      } else {
        const options = ['a', 'b', 'c', 'd'];
        
        optionsContainer.innerHTML = options.map(opt => {
          if (!question.options[opt]) return '';
          const isSelected = userAnswers[currentQuestionIndex] === opt;
          return `
            <button onclick="selectAnswer('${opt}')" class="option-btn w-full text-left p-4 rounded-xl border-2 ${isSelected ? 'selected border-violet-500 bg-violet-50' : 'border-gray-200'} transition">
              <span class="inline-flex items-center justify-center w-8 h-8 rounded-lg ${isSelected ? 'bg-violet-500 text-white' : 'bg-gray-100 text-gray-600'} font-semibold mr-3">${opt.toUpperCase()}</span>
              <span class="text-gray-800">${escapeHtml(question.options[opt])}</span>
            </button>
          `;
        }).join('');
      }

      // Update navigation buttons
      document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
      document.getElementById('next-btn').textContent = currentQuestionIndex === total - 1 ? 'Selesai' : 'Selanjutnya';
    }

    // Select answer
    function selectAnswer(option) {
      userAnswers[currentQuestionIndex] = option;
      renderQuestion();
    }

    // Select essay answer
    function selectEssayAnswer(answer) {
      userAnswers[currentQuestionIndex] = answer;
    }

    // Navigation
    function prevQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion();
      }
    }

    function nextQuestion() {
      if (currentQuestionIndex < tempQuestions.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
      } else {
        submitQuiz();
      }
    }

    // Submit quiz
    async function submitQuiz() {
      const quiz = allData.find(d => d.__backendId === currentQuizId);
      if (!quiz) return;

      let score = 0;
      let totalMultipleChoice = 0;
      
      tempQuestions.forEach((q, idx) => {
        // Hanya hitung soal pilihan ganda
        if (q.type !== 'essay') {
          totalMultipleChoice++;
          if (userAnswers[idx] === q.correct) {
            score++;
          }
        }
      });

      // Jika tidak ada soal pilihan ganda (hanya essay), hitung dari total
      const scoreTotal = totalMultipleChoice > 0 ? totalMultipleChoice : tempQuestions.length;

      // Check data limit
      if (allData.length >= 999) {
        showToast('Batas penyimpanan tercapai', 'error');
        showResult(score, scoreTotal);
        return;
      }

      const resultData = {
        type: 'result',
        result_id: 'result_' + Date.now(),
        result_quiz_id: quiz.quiz_id,
        result_participant_name: currentParticipant.name,
        result_participant_number: currentParticipant.number,
        result_score: score,
        result_total: scoreTotal,
        result_answers: JSON.stringify(userAnswers),
        result_completed_at: new Date().toISOString()
      };

      await window.dataSdk.create(resultData);
      showResult(score, tempQuestions.length);
    }

    // Show result
    function showResult(score, total) {
      const percent = Math.round((score / total) * 100);
      
      // Animate score circle
      const circumference = 2 * Math.PI * 88;
      const offset = circumference - (percent / 100) * circumference;
      document.getElementById('score-circle').style.strokeDasharray = `${circumference - offset} ${circumference}`;
      
      document.getElementById('score-percent').textContent = percent + '%';
      document.getElementById('correct-count').textContent = score;
      document.getElementById('incorrect-count').textContent = total - score;

      // Result message
      let message = '';
      if (percent >= 90) message = 'Luar biasa! Anda menguasai materi dengan sangat baik! ðŸŽ‰';
      else if (percent >= 70) message = 'Bagus! Anda memahami sebagian besar materi. ðŸ‘';
      else if (percent >= 50) message = 'Cukup baik, tetap semangat belajar! ðŸ’ª';
      else message = 'Jangan menyerah, terus belajar dan coba lagi! ðŸ“š';
      
      document.getElementById('result-message').textContent = message;

      // Render review
      const reviewContainer = document.getElementById('review-container');
      reviewContainer.innerHTML = tempQuestions.map((q, idx) => {
        const userAnswer = userAnswers[idx];
        
        // Handle essay questions
        if (q.type === 'essay') {
          return `
            <div class="p-4 rounded-xl bg-blue-50 border border-blue-200">
              <p class="font-medium text-gray-800 mb-2">${idx + 1}. ${escapeHtml(q.text)}</p>
              <div class="text-sm">
                <span class="text-blue-600 font-medium">Jawaban Anda:</span>
                <p class="mt-2 p-3 bg-white rounded border border-blue-100 text-gray-700">${escapeHtml(userAnswer || '-')}</p>
                <p class="text-xs text-blue-500 mt-2">Soal essay akan dikoreksi oleh guru</p>
              </div>
            </div>
          `;
        }
        
        // Handle multiple choice questions
        const isCorrect = userAnswer === q.correct;
        return `
          <div class="p-4 rounded-xl ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
            <p class="font-medium text-gray-800 mb-2">${idx + 1}. ${escapeHtml(q.text)}</p>
            <div class="flex gap-4 text-sm">
              <span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">
                Jawaban Anda: ${userAnswer ? userAnswer.toUpperCase() : '-'}
              </span>
              ${!isCorrect ? `<span class="text-green-600">Jawaban benar: ${q.correct ? q.correct.toUpperCase() : '-'}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');

      showView('result');
    }

    // Initialize on load
    function initializeApp() {
      // Check URL parameter untuk menentukan role (guru/siswa)
      const urlParams = new URLSearchParams(window.location.search);
      const userRole = urlParams.get('role') || localStorage.getItem('userRole') || 'student'; // Default: student
      
      // Simpan role ke localStorage
      localStorage.setItem('userRole', userRole);
      
      // Panggil initApp
      initApp();
      
      // Jika siswa, tampilkan halaman join quiz
      if (userRole === 'student') {
        setTimeout(() => {
          showView('join-quiz');
        }, 100);
      }
    }

    // Initialize on load
    initializeApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c9a9eac14763dc8',t:'MTc3MDM4MDYxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>